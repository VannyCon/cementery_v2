<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Cemetery Navigation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }

        #camera-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .ar-direction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .ar-arrow {
            font-size: 4rem;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        .ar-distance {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .ar-instruction {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 20;
            pointer-events: all;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .control-btn.danger {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .control-btn.danger:hover {
            background: rgba(244, 67, 54, 1);
        }

        .status-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 20;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .route-progress {
            background: rgba(255, 255, 255, 0.3);
            height: 8px;
            border-radius: 4px;
            width: 150px;
            overflow: hidden;
        }

        .route-progress-fill {
            background: #4CAF50;
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .compass {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .compass-needle {
            color: #f44336;
            font-size: 2rem;
            transform-origin: center;
            transition: transform 0.3s ease;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 350px;
            z-index: 30;
            backdrop-filter: blur(10px);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 30;
            backdrop-filter: blur(10px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .destination-info {
            position: absolute;
            bottom: 120px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 20;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .eta {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="camera-feed" autoplay muted playsinline></video>
        
        <div class="ar-overlay">
            <div class="ar-direction" id="ar-direction">
                <div class="ar-arrow" id="ar-arrow">‚Üë</div>
                <div class="ar-distance" id="ar-distance">Calculating...</div>
                <div class="ar-instruction" id="ar-instruction">Starting navigation...</div>
            </div>
        </div>

        <div class="status-bar">
            <div class="route-info">
                <span id="current-step">Step 1 of 5</span>
                <div class="route-progress">
                    <div class="route-progress-fill" id="progress-fill" style="width: 20%"></div>
                </div>
            </div>
            <div id="total-distance">0.5 km remaining</div>
        </div>

        <div class="compass">
            <div class="compass-needle" id="compass-needle">üß≠</div>
        </div>

        <div class="destination-info">
            <div>Destination: <strong id="destination-name">Grave A-101</strong></div>
            <div class="eta">ETA: <span id="eta-time">5 minutes</span></div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="toggleAR()">
                <span id="ar-toggle-text">Disable AR</span>
            </button>
            <button class="control-btn" onclick="recenterRoute()">
                üìç Recenter
            </button>
            <button class="control-btn danger" onclick="exitAR()">
                ‚ùå Exit
            </button>
        </div>
    </div>

    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <div>Initializing AR Navigation...</div>
    </div>

    <div class="error-message" id="error-message" style="display: none;">
        <h3>Camera Access Required</h3>
        <p>Please allow camera access to use AR navigation.</p>
        <button class="control-btn" onclick="requestCamera()" style="margin-top: 15px;">
            Try Again
        </button>
    </div>

    <script>
        class ARNavigator {
            constructor() {
                this.isARActive = true;
                this.currentPosition = null;
                this.destination = null;
                this.routeCoords = [];
                this.currentStepIndex = 0;
                this.heading = 0;
                this.watchId = null;
                this.orientationHandler = null;
                
                this.init();
            }

            async init() {
                try {
                    this.showLoading(true);
                    
                    // Load route data from localStorage
                    this.loadRouteData();
                    
                    // Request camera permission and start video
                    await this.startCamera();
                    
                    // Start location tracking
                    this.startLocationTracking();
                    
                    // Start orientation tracking
                    this.startOrientationTracking();
                    
                    this.showLoading(false);
                    this.updateNavigation();
                } catch (error) {
                    console.error('AR initialization failed:', error);
                    this.showError('Failed to initialize AR navigation');
                }
            }

            loadRouteData() {
                try {
                    const coordsStr = localStorage.getItem('cl_route_coords');
                    const distanceStr = localStorage.getItem('cl_route_distance_m');
                    
                    if (coordsStr) {
                        this.routeCoords = JSON.parse(coordsStr);
                        this.destination = this.routeCoords[this.routeCoords.length - 1];
                        
                        // Update UI with route info
                        document.getElementById('total-distance').textContent = 
                            `${(parseFloat(distanceStr || '0') / 1000).toFixed(2)} km remaining`;
                        document.getElementById('current-step').textContent = 
                            `Step 1 of ${this.routeCoords.length - 1}`;
                    } else {
                        throw new Error('No route data found');
                    }
                } catch (error) {
                    console.error('Failed to load route data:', error);
                    this.showError('No navigation route found. Please set a route first.');
                }
            }

            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    const video = document.getElementById('camera-feed');
                    video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            video.play();
                            resolve();
                        };
                    });
                } catch (error) {
                    console.error('Camera access failed:', error);
                    this.showError('Camera access is required for AR navigation');
                    throw error;
                }
            }

            startLocationTracking() {
                if (!navigator.geolocation) {
                    this.showError('Geolocation is not supported');
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 8000,
                    maximumAge: 0
                };

                this.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        this.currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        this.updateNavigation();
                    },
                    (error) => {
                        console.error('Location error:', error);
                        this.showError('Unable to get your location');
                    },
                    options
                );
            }

            startOrientationTracking() {
                if (window.DeviceOrientationEvent) {
                    this.orientationHandler = (event) => {
                        // Get compass heading (0-360 degrees)
                        this.heading = event.webkitCompassHeading || 
                                     (360 - event.alpha) || 0;
                        this.updateCompass();
                    };
                    
                    window.addEventListener('deviceorientation', this.orientationHandler);
                } else {
                    console.warn('Device orientation not supported');
                }
            }

            updateNavigation() {
                if (!this.currentPosition || !this.routeCoords.length) return;

                // Find next waypoint
                const nextWaypoint = this.routeCoords[this.currentStepIndex + 1];
                if (!nextWaypoint) {
                    this.showArrival();
                    return;
                }

                // Calculate distance and bearing to next waypoint
                const distance = this.calculateDistance(
                    this.currentPosition.lat, this.currentPosition.lng,
                    nextWaypoint[0], nextWaypoint[1]
                );
                
                const bearing = this.calculateBearing(
                    this.currentPosition.lat, this.currentPosition.lng,
                    nextWaypoint[0], nextWaypoint[1]
                );

                // Update AR display
                this.updateARDisplay(distance, bearing);
                
                // Check if we've reached the current waypoint
                if (distance < 10) { // Within 10 meters
                    this.currentStepIndex++;
                    this.updateProgress();
                }
            }

            updateARDisplay(distance, bearing) {
                if (!this.isARActive) return;

                const arDirection = document.getElementById('ar-direction');
                const arArrow = document.getElementById('ar-arrow');
                const arDistance = document.getElementById('ar-distance');
                const arInstruction = document.getElementById('ar-instruction');

                // Calculate relative bearing (bearing relative to device orientation)
                const relativeBearing = (bearing - this.heading + 360) % 360;
                
                // Update arrow direction
                let arrowSymbol = '‚Üë';
                let instruction = 'Continue straight';
                
                if (relativeBearing > 15 && relativeBearing <= 75) {
                    arrowSymbol = '‚Üó';
                    instruction = 'Turn slightly right';
                } else if (relativeBearing > 75 && relativeBearing <= 105) {
                    arrowSymbol = '‚Üí';
                    instruction = 'Turn right';
                } else if (relativeBearing > 105 && relativeBearing <= 165) {
                    arrowSymbol = '‚Üò';
                    instruction = 'Turn sharp right';
                } else if (relativeBearing > 165 && relativeBearing <= 195) {
                    arrowSymbol = '‚Üì';
                    instruction = 'Turn around';
                } else if (relativeBearing > 195 && relativeBearing <= 255) {
                    arrowSymbol = '‚Üô';
                    instruction = 'Turn sharp left';
                } else if (relativeBearing > 255 && relativeBearing <= 285) {
                    arrowSymbol = '‚Üê';
                    instruction = 'Turn left';
                } else if (relativeBearing > 285 && relativeBearing <= 345) {
                    arrowSymbol = '‚Üñ';
                    instruction = 'Turn slightly left';
                }

                arArrow.textContent = arrowSymbol;
                arDistance.textContent = distance < 1000 ? 
                    `${Math.round(distance)}m` : 
                    `${(distance/1000).toFixed(1)}km`;
                arInstruction.textContent = instruction;

                // Position AR elements based on bearing
                const screenX = 50 + (relativeBearing - 180) * 0.2; // Rough calculation
                arDirection.style.left = `${Math.max(10, Math.min(90, screenX))}%`;
            }

            updateCompass() {
                const needle = document.getElementById('compass-needle');
                needle.style.transform = `rotate(${this.heading}deg)`;
            }

            updateProgress() {
                const progressFill = document.getElementById('progress-fill');
                const currentStep = document.getElementById('current-step');
                
                const progress = ((this.currentStepIndex + 1) / (this.routeCoords.length - 1)) * 100;
                progressFill.style.width = `${Math.min(100, progress)}%`;
                currentStep.textContent = 
                    `Step ${this.currentStepIndex + 1} of ${this.routeCoords.length - 1}`;
            }

            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371000; // Earth's radius in meters
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            calculateBearing(lat1, lng1, lat2, lng2) {
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const lat1Rad = lat1 * Math.PI / 180;
                const lat2Rad = lat2 * Math.PI / 180;
                
                const y = Math.sin(dLng) * Math.cos(lat2Rad);
                const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                        Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
                
                const bearing = Math.atan2(y, x) * 180 / Math.PI;
                return (bearing + 360) % 360;
            }

            showArrival() {
                const arDirection = document.getElementById('ar-direction');
                arDirection.innerHTML = `
                    <div class="ar-arrow">üéØ</div>
                    <div class="ar-distance">Arrived!</div>
                    <div class="ar-instruction">You have reached your destination</div>
                `;
                
                // Celebrate arrival
                setTimeout(() => {
                    if (confirm('You have arrived at your destination! Return to map?')) {
                        this.exitAR();
                    }
                }, 2000);
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }

            showError(message) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.querySelector('p').textContent = message;
                errorDiv.style.display = 'block';
            }

            cleanup() {
                // Stop location tracking
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                }
                
                // Stop orientation tracking
                if (this.orientationHandler) {
                    window.removeEventListener('deviceorientation', this.orientationHandler);
                }
                
                // Stop camera
                const video = document.getElementById('camera-feed');
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
            }
        }

        // Global functions
        let arNavigator = null;

        window.addEventListener('load', () => {
            arNavigator = new ARNavigator();
        });

        function toggleAR() {
            if (!arNavigator) return;
            
            arNavigator.isARActive = !arNavigator.isARActive;
            const toggleText = document.getElementById('ar-toggle-text');
            const arDirection = document.getElementById('ar-direction');
            
            if (arNavigator.isARActive) {
                toggleText.textContent = 'Disable AR';
                arDirection.style.display = 'block';
            } else {
                toggleText.textContent = 'Enable AR';
                arDirection.style.display = 'none';
            }
        }

        function recenterRoute() {
            if (arNavigator) {
                arNavigator.updateNavigation();
            }
        }

        function exitAR() {
            if (confirm('Exit AR navigation and return to map?')) {
                if (arNavigator) {
                    arNavigator.cleanup();
                }
                window.history.back();
            }
        }

        function requestCamera() {
            document.getElementById('error-message').style.display = 'none';
            if (arNavigator) {
                arNavigator.startCamera().catch(() => {
                    document.getElementById('error-message').style.display = 'block';
                });
            }
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pause AR when page is hidden
                if (arNavigator) {
                    arNavigator.isARActive = false;
                }
            } else {
                // Resume AR when page is visible
                if (arNavigator) {
                    arNavigator.isARActive = true;
                }
            }
        });

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (arNavigator) {
                    arNavigator.updateNavigation();
                }
            }, 500);
        });
    </script>
</body>
</html>
